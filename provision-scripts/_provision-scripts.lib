#!/bin/bash

CREDS_FILE="../gen/workshop-credentials.json"

#*********************************
if [ -f "$CREDS_FILE" ]
then
    DT_BASEURL=$(cat $CREDS_FILE | jq -r '.DT_BASEURL')
    DT_API_TOKEN=$(cat $CREDS_FILE | jq -r '.DT_API_TOKEN')
    DT_PAAS_TOKEN=$(cat $CREDS_FILE | jq -r '.DT_PAAS_TOKEN')
    DT_ENVIRONMENT_ID=$(cat $CREDS_FILE | jq -r '.DT_ENVIRONMENT_ID')
    AZURE_RESOURCE_GROUP=$(cat $CREDS_FILE | jq -r '.AZURE_RESOURCE_GROUP')
    AZURE_SUBSCRIPTION=$(cat $CREDS_FILE | jq -r '.AZURE_SUBSCRIPTION')
    AZURE_LOCATION=$(cat $CREDS_FILE | jq -r '.AZURE_LOCATION')
    RESOURCE_PREFIX=$(cat $CREDS_FILE | jq -r '.RESOURCE_PREFIX')
    AZURE_AKS_CLUSTER_NAME=$(cat $CREDS_FILE | jq -r '.AZURE_AKS_CLUSTER_NAME')
    AZURE_AIFOUNDRY_NAME=$(cat $CREDS_FILE | jq -r '.AZURE_AIFOUNDRY_NAME')
    EMAIL=$(cat $CREDS_FILE | jq -r '.EMAIL')
    DASHBOARD_OWNER_EMAIL=$(cat $CREDS_FILE | jq -r '.EMAIL')
else
  echo "ABORT: CREDS_FILE: $CREDS_FILE not found"
  exit 1
fi

#*********************************
# Function to update the traveladvisor-combined.yaml manifest with AI Foundry credentials
# Parameters: $1 = endpoint, $2 = api_key
update_traveladvisor_manifest()
{
  ENDPOINT=$1
  API_KEY=$2
  
  TRAVELADVISOR_MANIFEST="../app-scripts/manifests/traveladvisor-combined.yaml"
  
  if [ -f "$TRAVELADVISOR_MANIFEST" ]; then
    echo "Updating Travel Advisor manifest with AI Foundry credentials..."
    
    # Update AZURE_OPENAI_ENDPOINT
    sed -i 's~AZURE_OPENAI_ENDPOINT:.*~AZURE_OPENAI_ENDPOINT: "'"$ENDPOINT"'"~' "$TRAVELADVISOR_MANIFEST"
    
    # Update AZURE_OPENAI_KEY
    sed -i 's~AZURE_OPENAI_KEY:.*~AZURE_OPENAI_KEY: "'"$API_KEY"'"~' "$TRAVELADVISOR_MANIFEST"
    
    # Update AZURE_OPENAI_API_KEY
    sed -i 's~AZURE_OPENAI_API_KEY:.*~AZURE_OPENAI_API_KEY: "'"$API_KEY"'"~' "$TRAVELADVISOR_MANIFEST"

    # Update OTEL_ENDPOINT
    OTEL_ENDPOINT="https://${DT_ENVIRONMENT_ID}.live.dynatrace.com/api/v2/otlp"
    sed -i 's~OTEL_ENDPOINT:.*~OTEL_ENDPOINT: "'"$OTEL_ENDPOINT"'"~' "$TRAVELADVISOR_MANIFEST"
    sed -i 's~OTEL_API_TOKEN:.*~OTEL_API_TOKEN: "'"$DT_API_TOKEN"'"~' "$TRAVELADVISOR_MANIFEST"
    
    echo "Updated $TRAVELADVISOR_MANIFEST with:"
    echo "  AZURE_OPENAI_ENDPOINT: $ENDPOINT"
    echo "  AZURE_OPENAI_KEY: [REDACTED]"
    echo "  AZURE_OPENAI_API_KEY: [REDACTED]"
  else
    echo "WARNING: Travel Advisor manifest not found at $TRAVELADVISOR_MANIFEST"
  fi
}

#*********************************
# Function to fetch and update AI Foundry endpoint and key in workshop-credentials.json
# Call this after the AI Foundry resource has been created
update_aifoundry_credentials()
{
  AIFOUNDRY_ACCOUNT_NAME=$1
  
  echo "Fetching AI Foundry endpoint and API key for: $AIFOUNDRY_ACCOUNT_NAME"
  
  # Get the AI Foundry endpoint
  AZURE_AIFOUNDRY_ENDPOINT=$(az cognitiveservices account show \
    --name "$AIFOUNDRY_ACCOUNT_NAME" \
    --resource-group "$AZURE_RESOURCE_GROUP" \
    --subscription "$AZURE_SUBSCRIPTION" \
    --query "properties.endpoint" \
    --output tsv 2>/dev/null)
  
  # Get the AI Foundry API key
  AZURE_AIFOUNDRY_MODEL_KEY=$(az cognitiveservices account keys list \
    --name "$AIFOUNDRY_ACCOUNT_NAME" \
    --resource-group "$AZURE_RESOURCE_GROUP" \
    --subscription "$AZURE_SUBSCRIPTION" \
    --query "key1" \
    --output tsv 2>/dev/null)
  
  # Debug: Check what values we got
  if [ -z "$AZURE_AIFOUNDRY_ENDPOINT" ]; then
    echo "DEBUG: AZURE_AIFOUNDRY_ENDPOINT is empty"
  fi
  if [ -z "$AZURE_AIFOUNDRY_MODEL_KEY" ]; then
    echo "DEBUG: AZURE_AIFOUNDRY_MODEL_KEY is empty"
  fi
  
  if [ -n "$AZURE_AIFOUNDRY_ENDPOINT" ] && [ -n "$AZURE_AIFOUNDRY_MODEL_KEY" ]; then
    # Update the credentials file using jq
    TEMP_FILE=$(mktemp)
    jq --arg endpoint "$AZURE_AIFOUNDRY_ENDPOINT" \
       --arg key "$AZURE_AIFOUNDRY_MODEL_KEY" \
       '.AZURE_AIFOUNDRY_ENDPOINT = $endpoint | .AZURE_AIFOUNDRY_MODEL_KEY = $key' \
       "$CREDS_FILE" > "$TEMP_FILE" && mv "$TEMP_FILE" "$CREDS_FILE"
    
    echo "Updated $CREDS_FILE with AI Foundry credentials"
    echo "  Endpoint: $AZURE_AIFOUNDRY_ENDPOINT"
    echo "  API Key: [REDACTED]"
    
    # Update the Travel Advisor Kubernetes manifest
    update_traveladvisor_manifest "$AZURE_AIFOUNDRY_ENDPOINT" "$AZURE_AIFOUNDRY_MODEL_KEY"
  else
    echo "WARNING: Could not fetch AI Foundry credentials for $AIFOUNDRY_ACCOUNT_NAME"
  fi
}

#*********************************
create_dynatrace_operator_secrets_script()
{
  # reference: https://www.dynatrace.com/support/help/technology-support/container-platforms/kubernetes/monitor-kubernetes-environments/

  SECRETS_TEMPLATE_FILE=dynatrace-secret.template
  SECRETS_GEN_FILE="../learner-scripts/create-dynatrace-secret.sh"

  # create new file from the template with learner Dynatrace tenant information
  echo "#!/bin/bash" > $SECRETS_GEN_FILE
  cat $SECRETS_TEMPLATE_FILE | \
    sed 's~DT_API_TOKEN_PLACEHOLDER~'"$DT_API_TOKEN"'~' | \
    sed 's~DT_PAAS_TOKEN_PLACEHOLDER~'"$DT_PAAS_TOKEN"'~' >> $SECRETS_GEN_FILE

  chmod +x $SECRETS_GEN_FILE
  echo "Saved dynatrace operator secrets script to: $SECRETS_GEN_FILE"
}

#*********************************
create_dynatrace_operator_custom_resource_file()
{
  # download custom resource file
  CR_TEMP_FILE="../learner-scripts/cr.tmp"
  CR_GEN_FILE="../learner-scripts/cr.yaml"
  curl -Lo $CR_TEMP_FILE https://github.com/Dynatrace/dynatrace-operator/releases/latest/download/cr.yaml

  # update with learner Dynatrace tenant information
  cat $CR_TEMP_FILE | \
    sed 's~https://ENVIRONMENTID.live.dynatrace.com~'"$DT_BASEURL"'~' > $CR_GEN_FILE

  rm $CR_TEMP_FILE
  echo "Saved custom resource file to: $CR_GEN_FILE"
}

#*********************************
does_aks_exist()
{
  AKSCHECK=$(az aks show -n $AZURE_AKS_CLUSTER_NAME --resource-group $AZURE_RESOURCE_GROUP --query id 2>&1 | grep "NotFound")
  if [ -z "$AKSCHECK" ]; then
    # No NotFound error, so cluster EXISTS
    echo true
  else
    # NotFound error found, so cluster does NOT exist
    echo false
  fi
}


#*********************************

#*********************************
create_aks_cluster()
{
  create_resource_group
  PROVISIONING_STEP="06-Create-AKS-cluster"
  JSON_EVENT='{"id":"1","step":"'"$PROVISIONING_STEP"'","event.provider":"azure-workshop-provisioning","event.category":"azure-workshop","user":"'"$EMAIL"'","event.type":"provisioning-step","vmState":"AKS running","DT_ENVIRONMENT_ID":"'"$DT_ENVIRONMENT_ID"'"}'
  # only create if it does not exist
  if [ "$(does_aks_exist)" == "false" ]; then
    echo ""
    echo "Creating AKS Cluster: $AZURE_AKS_CLUSTER_NAME"
    az aks create \
      --resource-group $AZURE_RESOURCE_GROUP \
      --name $AZURE_AKS_CLUSTER_NAME \
      --node-count 4 \
      --node-vm-size 'Standard_DS2_v2' \
      --subscription $AZURE_SUBSCRIPTION \
      --os-sku AzureLinux \
      --tags Owner=azure-modernize-workshop \
      --enable-addons monitoring \
      --generate-ssh-keys
    DT_SEND_EVENT=$(curl -s -X POST https://dt-event-send-dteve5duhvdddbea.eastus2-01.azurewebsites.net/api/send-event \
     -H "Content-Type: application/json" \
     -d "$JSON_EVENT")
  else
    echo "ABORT: AKS Cluster $AZURE_AKS_CLUSTER_NAME already exists"
    exit 1
  fi
}

#*********************************
delete_aks_cluster()
{
  # only delete if it exists
  if [ "$(az group show -n $AZURE_RESOURCE_GROUP --resource-group $AZURE_RESOURCE_GROUP --query id 2>/dev/null)" ]; then
    echo "Deleting AKS Cluster: $AZURE_RESOURCE_GROUP"
    az aks delete \
      --resource-group $AZURE_RESOURCE_GROUP \
      --name $AZURE_AKS_CLUSTER_NAME \
      --yes
  else
    echo "AKS Cluster $AZURE_RESOURCE_GROUP not found"
  fi
}

#*********************************
create_azure_service_principal()
{
  AZURE_SP_NAME="$AZURE_RESOURCE_GROUP-sp"
  AZURE_SP_JSON_FILE="../gen/workshop-azure-service-principal.json"

  # delete sp if it exists
  echo "Seeing if $AZURE_SP_NAME exists in Azure"
  ID=$(az ad sp list --only-show-errors --query [] --filter "displayname eq '$AZURE_SP_NAME'" --query [].appId -o tsv)
  if ! [ -z "$ID" ]; then
      echo "Deleting existing $AZURE_SP_NAME within Azure"
      az ad sp delete --only-show-errors --id $ID
  else
      echo "$AZURE_SP_NAME did not exist in Azure"
  fi

  echo "Adding $AZURE_SP_NAME to Azure and sending output to $AZURE_SP_JSON_FILE"
  az ad sp create-for-rbac \
      --name "$AZURE_SP_NAME" \
      --role reader \
      --scopes "/subscriptions/$AZURE_SUBSCRIPTION" \
      --only-show-errors \
      > "$AZURE_SP_JSON_FILE"

  echo "Sleeping 10 seconds to allow for Azure subscription creation"
  sleep 10
}

#*********************************
delete_azure_service_principal()
{
  AZURE_SP_NAME="$AZURE_RESOURCE_GROUP-sp"
  AZURE_SP_JSON_FILE="../gen/workshop-azure-service-principal.json"

  # delete sp if it exists
  echo "Seeing if $AZURE_SP_NAME exists in Azure"
  ID=$(az ad sp list --only-show-errors --query [] --filter "displayname eq '$AZURE_SP_NAME'" --query [].appId -o tsv)
  if ! [ -z "$ID" ]; then
      echo "Deleting existing $AZURE_SP_NAME within Azure"
      az ad sp delete --only-show-errors --id $ID
  else
      echo "$AZURE_SP_NAME did not exist in Azure"
  fi
}

#*********************************
does_vm_exist()
{
  VMCHECK=$(az vm get-instance-view -g $AZURE_RESOURCE_GROUP -n $HOSTNAME --subscription $AZURE_SUBSCRIPTION --query vmId 2>&1 | grep "ResourceNotFound")
  if [ -z "$VMCHECK" ]; then
    #error so VM DOES exist because VMCheck is blank
    echo true
  else
   #error in VMCheck so VM does NOT exist
    echo false
  fi
}

#*********************************
# https://www.dynatrace.com/support/help/technology-support/cloud-platforms/microsoft-azure/azure-services/virtual-machines/deploy-oneagent-on-azure-virtual-machines/
# can add , \"enableLogsAnalytics\":\"yes\"
add_oneagent_extension()
{
  AGENT=$1  # values oneAgentLinux,oneAgentWindows
  HOSTGROUP_NAME=$2
  echo ""
  echo "Adding OneAgent extension for $HOSTNAME"

  EXTENTION_STATUS="$(az vm extension set \
    --publisher dynatrace.ruxit \
    --name "$AGENT" \
    --resource-group "$AZURE_RESOURCE_GROUP" \
    --subscription "$AZURE_SUBSCRIPTION" \
    --vm-name "$HOSTNAME" \
    --settings "{\"tenantId\":\"$DT_ENVIRONMENT_ID\",\"token\":\"$DT_PAAS_TOKEN\", \"server\":\"$DT_BASEURL/api\", \"hostGroup\":\"$HOSTGROUP_NAME\"}" \
    | jq -r '.provisioningState')"

  echo "Extension Installation Status: $EXTENTION_STATUS"
  echo ""
}

#*********************************
create_resource_group()
{
  PROVISIONING_STEP="04-Create-resource-group"
  JSON_EVENT='{"id":"1","step":"'"$PROVISIONING_STEP"'","event.provider":"azure-workshop-provisioning","event.category":"azure-workshop","user":"'"$EMAIL"'","event.type":"provisioning-step","DT_ENVIRONMENT_ID":"'"$DT_ENVIRONMENT_ID"'"}'
        if [ "$(does_group_exist)" == "true" ]; then
            echo "Skipping, resource group $AZURE_RESOURCE_GROUP exists"
            echo ""
        else
            echo ""
            echo "Provisioning resource group: $AZURE_RESOURCE_GROUP"
            echo "--------"
             az group create \
              --location "$AZURE_LOCATION" \
              --name "$AZURE_RESOURCE_GROUP" \
              --subscription "$AZURE_SUBSCRIPTION"
            echo "-------"
            DT_SEND_EVENT=$(curl -s -X POST https://dt-event-send-dteve5duhvdddbea.eastus2-01.azurewebsites.net/api/send-event \
              -H "Content-Type: application/json" \
              -d "$JSON_EVENT")
        fi

}

#*********************************
does_group_exist()
{
  GROUPCHECK=$(az group show -g $AZURE_RESOURCE_GROUP --output tsv --query id 2>&1 | grep "NotFound")
  if [ -z "$GROUPCHECK" ]; then
    echo true
  else
    echo false
  fi
}
#*********************************
#*********************************
delete_resource_group()
{
  PROVISIONING_STEP="99-Delete-resource-group"
  JSON_EVENT='{"id":"1","step":"'"$PROVISIONING_STEP"'","event.provider":"azure-workshop-provisioning","event.category":"azure-workshop","user":"'"$EMAIL"'","event.type":"provisioning-step","DT_ENVIRONMENT_ID":"'"$DT_ENVIRONMENT_ID"'"}'

  # only delete if it exists
  if [ "$(az group show -n $AZURE_RESOURCE_GROUP --subscription $AZURE_SUBSCRIPTION --query id 2>/dev/null)" ]; then
    echo "Deleting resource group: $AZURE_RESOURCE_GROUP"
    az group delete \
      --resource-group "$AZURE_RESOURCE_GROUP" \
      --subscription "$AZURE_SUBSCRIPTION" \
      --yes
    DT_SEND_EVENT=$(curl -s -X POST https://dt-event-send-dteve5duhvdddbea.eastus2-01.azurewebsites.net/api/send-event \
     -H "Content-Type: application/json" \
     -d "$JSON_EVENT")
  else
    echo "Resource group $AZURE_RESOURCE_GROUP not found"
  fi
}

#*********************************
provision_linux_active_gate()
{
  HOSTNAME="dt-orders-active-gate"

  # make cloud-init with users API and TOKEN info
  ACTIVATE_GATE_FILE="../gen/cloud-init-activegate.txt"

  echo "#cloud-config" > $ACTIVATE_GATE_FILE
  echo "runcmd:" >> $ACTIVATE_GATE_FILE
  echo "  - wget -O /tmp/Dynatrace-ActiveGate-Linux-x86.sh \"$DT_BASEURL/api/v1/deployment/installer/gateway/unix/latest?arch=x86&flavor=default\" --header=\"Authorization:Api-Token $DT_PAAS_TOKEN\"" >> $ACTIVATE_GATE_FILE
  echo "  - sudo /bin/bash /tmp/Dynatrace-ActiveGate-Linux-x86.sh" >> $ACTIVATE_GATE_FILE
  echo "" >> $ACTIVATE_GATE_FILE

  echo "Checking if $HOSTNAME already exists"
  #echo "If you see 'ERROR: (ResourceNotFound)', that is OK.  Its just the output from azure CLI"
  echo ""
  if [ "$(does_vm_exist)" == "true" ]; then
    echo "Skipping, host $HOSTNAME exists"
    echo ""
  else
    #echo ""
    echo "Host doesn't exist; Provisioning $HOSTNAME"

    VM_STATE="$(az vm create \
      --name "$HOSTNAME" \
      --resource-group "$AZURE_RESOURCE_GROUP" \
      --image "Ubuntu2204" \
      --custom-data "$ACTIVATE_GATE_FILE" \
      --tags Owner=azure-modernize-workshop \
      --subscription "$AZURE_SUBSCRIPTION" \
      --location "$AZURE_LOCATION" \
      --authentication-type password \
      --admin-username azureuser \
      --admin-password Azureuser123# \
      --public-ip-sku Standard \
      --size Standard_DS2_v2 \
      | jq -r '.powerState')"

    echo "VM State: $VM_STATE"
    if [ "$VM_STATE" != "VM running" ]; then
      echo "Aborting due to VM creation error."
      return 1
    fi
  fi
}

#*********************************
# cloud-init logs: /var/log/cloud-init.log
provision_monolith_vm()
{
  PROVISIONING_STEP="05-Provision-monolith-VM"
  INIT_TEMPLATE_FILE=cloud-init-monolith.template
  INIT_FILE_GEN=../gen/cloud-init-monolith.txt

  cat $INIT_TEMPLATE_FILE | \
    sed 's~DT_PAAS_TOKEN_PLACEHOLDER~'"$DT_PAAS_TOKEN"'~' | \
    sed 's~DT_BASEURL_PLACEHOLDER~'"$DT_BASEURL"'~' > $INIT_FILE_GEN  

  HOSTNAME="dt-orders-monolith"
  echo "Checking if $HOSTNAME already exists"
  #echo "If you see 'ERROR: (ResourceNotFound)', that is OK.  Its just the output from azure CLI"
  #echo ""
  if [ "$(does_vm_exist)" == "true" ]; then
    echo "Skipping, host $HOSTNAME exists"
    echo ""
  else
    echo ""
    echo "Host doesn't exist; Provisioning $HOSTNAME"

    VM_STATE="$(az vm create \
      --name "$HOSTNAME" \
      --resource-group "$AZURE_RESOURCE_GROUP" \
      --image Ubuntu2204 \
      --tags Owner=azure-modernize-workshop \
      --subscription "$AZURE_SUBSCRIPTION" \
      --location "$AZURE_LOCATION" \
      --custom-data "$INIT_FILE_GEN" \
      --authentication-type password \
      --admin-username workshop \
      --admin-password Workshop123# \
      --size Standard_DS11-1_v2 \
      --public-ip-sku Standard \
      | jq -r '.powerState')"
    JSON_EVENT='{"id":"1","step":"'"$PROVISIONING_STEP"'","event.provider":"azure-workshop-provisioning","event.category":"azure-workshop","user":"'"$EMAIL"'","event.type":"provisioning-step","vmState":"'"$VM_STATE"'","DT_ENVIRONMENT_ID":"'"$DT_ENVIRONMENT_ID"'"}'
    DT_SEND_EVENT=$(curl -s -X POST https://dt-event-send-dteve5duhvdddbea.eastus2-01.azurewebsites.net/api/send-event \
     -H "Content-Type: application/json" \
     -d "$JSON_EVENT")
    echo "VM State: $VM_STATE"
    if [ "$VM_STATE" != "VM running" ]; then
      echo "Aborting due to VM creation error."
      return 1
    else
      echo "Opening Ports"
      OPEN_PORT="$(az vm open-port --port 80 --priority 1010 --resource-group "$AZURE_RESOURCE_GROUP" --name "$HOSTNAME" --subscription "$AZURE_SUBSCRIPTION")"
    fi
  fi
}

#*********************************
# cloud-init logs: /var/log/cloud-init.log
provision_services_vm()
{
  INIT_TEMPLATE_FILE=cloud-init-services.template
  INIT_FILE_GEN=../gen/cloud-init-services.txt

  cat $INIT_TEMPLATE_FILE | \
    sed 's~DT_PAAS_TOKEN_PLACEHOLDER~'"$DT_PAAS_TOKEN"'~' | \
    sed 's~DT_BASEURL_PLACEHOLDER~'"$DT_BASEURL"'~' > $INIT_FILE_GEN

  HOSTNAME="dt-orders-services"
  echo "Checking if $HOSTNAME already exists"
  #echo "If you see 'ERROR: (ResourceNotFound)', that is OK.  Its just the output from azure CLI"
  echo ""
  if [ "$(does_vm_exist)" == "true" ]; then
    echo "Skipping, host $HOSTNAME exists"
    echo ""
  else
    echo ""
    echo "Provisioning $HOSTNAME"

    VM_STATE="$(az vm create \
      --name "$HOSTNAME" \
      --resource-group "$AZURE_RESOURCE_GROUP" \
      --image Ubuntu2204 \
      --tags Owner=azure-modernize-workshop \
      --subscription "$AZURE_SUBSCRIPTION" \
      --location "$AZURE_LOCATION" \
      --custom-data "$INIT_FILE_GEN" \
      --authentication-type password \
      --admin-username workshop \
      --admin-password Workshop123# \
      --size Standard_DS2_v2 \
      | jq -r '.powerState')"

    echo "VM State: $VM_STATE"
    if [ "$VM_STATE" != "VM running" ]; then
      echo "Aborting due to VM creation error."
      return 1
    else
      echo "Opening Ports"
      OPEN_PORT="$(az vm open-port --port 80 --priority 1010 --resource-group "$AZURE_RESOURCE_GROUP" --name "$HOSTNAME" --subscription "$AZURE_SUBSCRIPTION")"
    fi
  fi
}

createhost() {
  #*********************************
  # Reference:
  # Dynatrace: https://www.dynatrace.com/support/help/technology-support/cloud-platforms/microsoft-azure/azure-services/virtual-machines/deploy-oneagent-on-azure-virtual-machines
  # Azure:     https://docs.microsoft.com/en-us/cli/azure/vm?view=azure-cli-latest#az-vm-create
  #*********************************
  HOST_TYPE=$1

  echo "==================================================================================="
  create_resource_group
  case $HOST_TYPE in
  monolith)
    echo "Provisioning $HOST_TYPE : Starting: $(date)"
    provision_monolith_vm $HOST_CTR
    ;;
  services)
    echo "Provisioning $HOST_TYPE : Starting: $(date)"
    provision_services_vm $HOST_CTR
    ;;
  active-gate)
    echo "Provisioning $HOST_TYPE : Starting: $(date)"
    provision_linux_active_gate $HOST_CTR
    ;;
  *)
    echo "Invalid HOST_TYPE option: $HOST_TYPE"
    return 1
    ;;
  esac
  echo "*** Done. $(date) ***"
  echo "==================================================================================="
}

does_opsmgmt_resource_provider_exist()
{
  RESOURCE_PROVIDER=$(az provider list --query "sort_by([?namespace=='Microsoft.OperationsManagement'].{Status:registrationState}, &Status)" --out tsv)
  if [ "$RESOURCE_PROVIDER" == "Registered" ]; then
    echo true
  else
    echo false
  fi

}

register_azure_opsmgmt_resource_provider()
{
  PROVISIONING_STEP="02-Register-opsmgmt-resource-provider"
  JSON_EVENT='{"id":"1","step":"'"$PROVISIONING_STEP"'","event.provider":"azure-workshop-provisioning","event.category":"azure-workshop","user":"'"$EMAIL"'","event.type":"provisioning-step","DT_ENVIRONMENT_ID":"'"$DT_ENVIRONMENT_ID"'"}'

  echo "==================================================================================="
  if [ "$(does_opsmgmt_resource_provider_exist)" == "false" ]; then
    echo "Microsoft.OperationsManagement ResourceProvider at Subscription level not found..."    
    echo "Registering Microsoft.OperationsManagement Resource Provider at the Subscription for provisioning of AKS cluster"
    REGISTER_RESOURCE_PROVIDER=$(az provider register --only-show-errors --namespace 'Microsoft.OperationsManagement')
    DT_SEND_EVENT=$(curl -s -X POST https://dt-event-send-dteve5duhvdddbea.eastus2-01.azurewebsites.net/api/send-event -H "Content-Type: application/json"  -d "$JSON_EVENT")
  else
    echo "Resource  Provider Microsoft.OperationsManagement is already registered at the subscription, moving to next task...."    
    DT_SEND_EVENT=$(curl -s -X POST https://dt-event-send-dteve5duhvdddbea.eastus2-01.azurewebsites.net/api/send-event -H "Content-Type: application/json" -d "$JSON_EVENT")
  fi

}

does_msinsights_resource_provider_exist()
{
  RESOURCE_PROVIDER=$(az provider list --query "sort_by([?namespace=='microsoft.insights'].{Status:registrationState}, &Status)" --out tsv)
  if [ "$RESOURCE_PROVIDER" == "Registered" ]; then
    echo true
  else
    echo false
  fi

}

register_azure_msinsights_resource_provider()
{
  PROVISIONING_STEP="03-Register-msinsights-resource-provider"
  JSON_EVENT='{"id":"1","step":"'"$PROVISIONING_STEP"'","event.provider":"azure-workshop-provisioning","event.category":"azure-workshop","user":"'"$EMAIL"'","event.type":"provisioning-step","DT_ENVIRONMENT_ID":"'"$DT_ENVIRONMENT_ID"'"}'

  echo "==================================================================================="
  if [ "$(does_msinsights_resource_provider_exist)" == "false" ]; then
    echo "microsoft.insights ResourceProvider at Subscription level not found..."
    echo "Registering microsoft.insights Resource Provider at the Subscription for provisioning of AKS cluster"
    REGISTER_RESOURCE_PROVIDER=$(az provider register --only-show-errors --namespace 'microsoft.insights')
    DT_SEND_EVENT=$(curl -s -X POST https://dt-event-send-dteve5duhvdddbea.eastus2-01.azurewebsites.net/api/send-event \
      -H "Content-Type: application/json" \
      -d "$JSON_EVENT")
  else
    echo "Resource  Provider microsoft.insights is already registered at the subscription, moving to next task...."
    DT_SEND_EVENT=$(curl -s -X POST https://dt-event-send-dteve5duhvdddbea.eastus2-01.azurewebsites.net/api/send-event \
      -H "Content-Type: application/json" \
      -d "$JSON_EVENT")
  fi
}

does_mscontainerservice_resource_provider_exist()
{
  RESOURCE_PROVIDER=$(az provider list --query "sort_by([?namespace=='Microsoft.ContainerService'].{Status:registrationState}, &Status)" --out tsv)
  if [ "$RESOURCE_PROVIDER" == "Registered" ]; then
    echo true
  else
    echo false
  fi
}

register_azure_mscontainerservice_resource_provider()
{
  PROVISIONING_STEP="03-Register-mscontainerservice-resource-provider"
  JSON_EVENT='{"id":"1","step":"'"$PROVISIONING_STEP"'","event.provider":"azure-workshop-provisioning","event.category":"azure-workshop","user":"'"$EMAIL"'","event.type":"provisioning-step","DT_ENVIRONMENT_ID":"'"$DT_ENVIRONMENT_ID"'"}'

  echo "==================================================================================="
  if [ "$(does_mscontainerservice_resource_provider_exist)" == "false" ]; then
    echo "Microsoft.ContainerService ResourceProvider at Subscription level not found..."
    echo "Registering Microsoft.ContainerService Resource Provider at the Subscription for provisioning of AKS cluster"
    REGISTER_RESOURCE_PROVIDER=$(az provider register --only-show-errors --namespace 'Microsoft.ContainerService')
    DT_SEND_EVENT=$(curl -s -X POST https://dt-event-send-dteve5duhvdddbea.eastus2-01.azurewebsites.net/api/send-event \
      -H "Content-Type: application/json" \
      -d "$JSON_EVENT")
  else
    echo "Resource  Provider Microsoft.ContainerService is already registered at the subscription, moving to next task...."
    DT_SEND_EVENT=$(curl -s -X POST https://dt-event-send-dteve5duhvdddbea.eastus2-01.azurewebsites.net/api/send-event \
      -H "Content-Type: application/json" \
      -d "$JSON_EVENT")
  fi
}

checkNumOfAzureResourcesInGroup() {
  RESOURCE_COUNT=$(az resource list --resource-group "$AZURE_RESOURCE_GROUP" --subscription "$AZURE_SUBSCRIPTION" --query "length([])" -o tsv)
  echo "$RESOURCE_COUNT"
}

#*********************************
does_cognitiveservices_resource_provider_exist()
{
  RESOURCE_PROVIDER=$(az provider list --query "sort_by([?namespace=='Microsoft.CognitiveServices'].{Status:registrationState}, &Status)" --out tsv)
  if [ "$RESOURCE_PROVIDER" == "Registered" ]; then
    echo true
  else
    echo false
  fi
}

#*********************************
register_azure_cognitiveservices_resource_provider()
{
  PROVISIONING_STEP="03-Register-cognitiveservices-resource-provider"
  JSON_EVENT='{"id":"1","step":"'"$PROVISIONING_STEP"'","event.provider":"azure-workshop-provisioning","event.category":"azure-workshop","user":"'"$EMAIL"'","event.type":"provisioning-step","DT_ENVIRONMENT_ID":"'"$DT_ENVIRONMENT_ID"'"}'

  echo "==================================================================================="
  if [ "$(does_cognitiveservices_resource_provider_exist)" == "false" ]; then
    echo "Microsoft.CognitiveServices ResourceProvider at Subscription level not found..."
    echo "Registering Microsoft.CognitiveServices Resource Provider at the Subscription for provisioning of AI Foundry"
    REGISTER_RESOURCE_PROVIDER=$(az provider register --only-show-errors --namespace 'Microsoft.CognitiveServices')
    echo "Waiting for resource provider registration to complete..."
    sleep 30
    DT_SEND_EVENT=$(curl -s -X POST https://dt-event-send-dteve5duhvdddbea.eastus2-01.azurewebsites.net/api/send-event \
      -H "Content-Type: application/json" \
      -d "$JSON_EVENT")
  else
    echo "Resource Provider Microsoft.CognitiveServices is already registered at the subscription, moving to next task...."
    DT_SEND_EVENT=$(curl -s -X POST https://dt-event-send-dteve5duhvdddbea.eastus2-01.azurewebsites.net/api/send-event \
      -H "Content-Type: application/json" \
      -d "$JSON_EVENT")
  fi
}

#*********************************
does_aifoundry_exist()
{
  AIFOUNDRY_RESULT=$(az cognitiveservices account show --name "$AZURE_AIFOUNDRY_NAME" --resource-group "$AZURE_RESOURCE_GROUP" --subscription "$AZURE_SUBSCRIPTION" --query id --output tsv 2>&1)
  # Check if the result contains an error
  if echo "$AIFOUNDRY_RESULT" | grep -qE "ResourceNotFound|ResourceGroupNotFound|ERROR"; then
    # Error found, so AI Foundry does NOT exist
    echo false
  elif [ -n "$AIFOUNDRY_RESULT" ]; then
    # Got a valid ID back, resource EXISTS
    echo true
  else
    # Empty result, assume not found
    echo false
  fi
}

#*********************************
does_aifoundry_model_deployment_exist()
{
  MODEL_DEPLOYMENT_NAME=$1
  DEPLOYMENT_CHECK=$(az cognitiveservices account deployment show --name "$AZURE_AIFOUNDRY_NAME" --resource-group "$AZURE_RESOURCE_GROUP" --subscription "$AZURE_SUBSCRIPTION" --deployment-name "$MODEL_DEPLOYMENT_NAME" --query id 2>&1 | grep "NotFound")
  if [ -z "$DEPLOYMENT_CHECK" ]; then
    echo true
  else
    echo false
  fi
}

#*********************************
provision_ai_foundry()
{
  PROVISIONING_STEP="07-Provision-AI-Foundry"
  JSON_EVENT='{"id":"1","step":"'"$PROVISIONING_STEP"'","event.provider":"azure-workshop-provisioning","event.category":"azure-workshop","user":"'"$EMAIL"'","event.type":"provisioning-step","DT_ENVIRONMENT_ID":"'"$DT_ENVIRONMENT_ID"'"}'
  
  echo ""
  echo "==================================================================================="
  echo "Provisioning AI Foundry Resources in Resource Group: $AZURE_RESOURCE_GROUP"
  echo "==================================================================================="
  
  # Check if AI Foundry already exists
  AIFOUNDRY_EXISTS=$(does_aifoundry_exist)
  
  if [ "$AIFOUNDRY_EXISTS" == "true" ]; then
    echo "AI Foundry account $AZURE_AIFOUNDRY_NAME already exists. Skipping creation..."
  else
    echo "Creating AI Foundry resource: $AZURE_AIFOUNDRY_NAME"
    CREATE_OUTPUT=$(az cognitiveservices account create \
      --name "$AZURE_AIFOUNDRY_NAME" \
      --resource-group "$AZURE_RESOURCE_GROUP" \
      --kind AIServices \
      --sku S0 \
      --location "$AZURE_LOCATION" \
      --yes \
      --subscription "$AZURE_SUBSCRIPTION" \
      --tags Owner=azure-modernize-workshop 2>&1)
    CREATE_EXIT_CODE=$?
    
    if [ $CREATE_EXIT_CODE -ne 0 ]; then
      echo "ERROR: AI Foundry creation command failed with exit code $CREATE_EXIT_CODE"
      echo "Error details: $CREATE_OUTPUT"
    else
      echo "AI Foundry create command completed."
    fi
    
    # Wait a moment for Azure to register the resource
    echo "Waiting for AI Foundry resource to be ready..."
    sleep 15
  fi
  
  # Verify the resource was created successfully by checking its provisioning state
  AI_FOUNDRY_CREATION_STATUS=$(az cognitiveservices account show \
    --name "$AZURE_AIFOUNDRY_NAME" \
    --resource-group "$AZURE_RESOURCE_GROUP" \
    --subscription "$AZURE_SUBSCRIPTION" \
    --query "properties.provisioningState" \
    --output tsv 2>&1)
  
  echo "AI Foundry Status: $AI_FOUNDRY_CREATION_STATUS"
  
  if [ "$AI_FOUNDRY_CREATION_STATUS" == "Succeeded" ]; then
    echo "AI Foundry account ready."
    
    # Check if model deployment already exists
    MODEL_DEPLOYMENT_NAME="gpt-4o"
    if [ "$(does_aifoundry_model_deployment_exist "$MODEL_DEPLOYMENT_NAME")" == "true" ]; then
      echo "Model deployment $MODEL_DEPLOYMENT_NAME already exists. Skipping deployment..."
    else
      echo "Deploying model: $MODEL_DEPLOYMENT_NAME"
      az cognitiveservices account deployment create \
        --name "$AZURE_AIFOUNDRY_NAME" \
        --resource-group "$AZURE_RESOURCE_GROUP" \
        --deployment-name "$MODEL_DEPLOYMENT_NAME" \
        --model-name "gpt-4o" \
        --model-version "2024-05-13" \
        --model-format OpenAI \
        --sku-name "Standard" \
        --sku-capacity 1 \
        --subscription "$AZURE_SUBSCRIPTION" \
        --output none
      
      # Wait for deployment to complete
      echo "Waiting for model deployment to complete..."
      sleep 15
    fi
    
    # Verify the model deployment status
    DEPLOY_AI_FOUNDRY_MODEL=$(az cognitiveservices account deployment show \
      --name "$AZURE_AIFOUNDRY_NAME" \
      --resource-group "$AZURE_RESOURCE_GROUP" \
      --subscription "$AZURE_SUBSCRIPTION" \
      --deployment-name "$MODEL_DEPLOYMENT_NAME" \
      --query "properties.provisioningState" \
      --output tsv 2>/dev/null)
    
    echo "Model Deployment Status: $DEPLOY_AI_FOUNDRY_MODEL"
    
    if [ "$DEPLOY_AI_FOUNDRY_MODEL" == "Succeeded" ]; then
      echo "AI Foundry model deployed successfully."
      PROVISIONING_STEP="07-Provision-AI-Foundry - Resource and Model Deployed"
      JSON_EVENT='{"id":"1","step":"'"$PROVISIONING_STEP"'","event.provider":"azure-workshop-provisioning","event.category":"azure-workshop","user":"'"$EMAIL"'","event.type":"provisioning-step","DT_ENVIRONMENT_ID":"'"$DT_ENVIRONMENT_ID"'"}'
      DT_SEND_EVENT=$(curl -s -X POST https://dt-event-send-dteve5duhvdddbea.eastus2-01.azurewebsites.net/api/send-event \
        -H "Content-Type: application/json" \
        -d "$JSON_EVENT")
      
      # Update credentials file with AI Foundry endpoint and key
      update_aifoundry_credentials "$AZURE_AIFOUNDRY_NAME"
    else
      echo "AI Foundry model deployment failed."
      PROVISIONING_STEP="90-Provision-AI-Foundry - Model Deployment FAILED"
      JSON_EVENT='{"id":"1","step":"'"$PROVISIONING_STEP"'","event.provider":"azure-workshop-provisioning","event.category":"azure-workshop","user":"'"$EMAIL"'","event.type":"provisioning-step","DT_ENVIRONMENT_ID":"'"$DT_ENVIRONMENT_ID"'"}'
      DT_SEND_EVENT=$(curl -s -X POST https://dt-event-send-dteve5duhvdddbea.eastus2-01.azurewebsites.net/api/send-event \
        -H "Content-Type: application/json" \
        -d "$JSON_EVENT")
      return 1
    fi
  else
    echo "AI Foundry creation failed."
    PROVISIONING_STEP="90-Provision-AI-Foundry - Resource Deployment FAILED"
    JSON_EVENT='{"id":"1","step":"'"$PROVISIONING_STEP"'","event.provider":"azure-workshop-provisioning","event.category":"azure-workshop","user":"'"$EMAIL"'","event.type":"provisioning-step","DT_ENVIRONMENT_ID":"'"$DT_ENVIRONMENT_ID"'"}'
    DT_SEND_EVENT=$(curl -s -X POST https://dt-event-send-dteve5duhvdddbea.eastus2-01.azurewebsites.net/api/send-event \
      -H "Content-Type: application/json" \
      -d "$JSON_EVENT")
    return 1
  fi
  
  echo "==================================================================================="
}